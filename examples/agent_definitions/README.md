# Dynamic Agent Definitions

このディレクトリには、Admin API経由で登録可能な動的エージェント定義のサンプルが含まれています。

## エージェント定義の登録方法

### 1. Admin APIで登録

```bash
curl -X POST http://localhost:8000/api/v1/admin/agents \
  -H "Content-Type: application/json" \
  -H "X-Access-Key: your-access-key" \
  -d @advanced_servicenow_agent.json
```

### 2. 登録されたエージェントの確認

```bash
curl http://localhost:8000/api/v1/admin/agents \
  -H "X-Access-Key: your-access-key"
```

### 3. エージェントのテスト

```bash
curl -X POST http://localhost:8000/api/v1/admin/agents/dynamic/advanced_servicenow_agent/test \
  -H "Content-Type: application/json" \
  -H "X-Access-Key: your-access-key" \
  -H "X-Service-Tokens: $(echo '{"frontend_session":{"token":"test_token"}}' | base64)" \
  -d '{
    "test_input": "エラーコード500について調べて",
    "task_params": {
      "query": "エラーコード500"
    }
  }'
```

## エージェント定義の構造

### 基本構造

```json
{
  "name": "agent_name",
  "description": "エージェントの説明",
  "capabilities": ["capability1", "capability2"],
  "tools": ["tool1", "tool2"],
  "executor": {
    "type": "llm|rule_based|hybrid",
    "system_prompt": "エージェントへのカスタム指示",
    "temperature": 0.0,
    "max_tokens": 4096,
    "model_id": "モデルID（オプション）"
  },
  "retry_strategy": {
    "max_attempts": 3,
    "retry_conditions": ["no_results"],
    "query_modification": "synonym|broader|narrower|llm_rewrite"
  },
  "priority": 10,
  "enabled": true
}
```

## カスタム指示 (system_prompt) の書き方

### 基本テンプレート

```
あなたは、[エージェントの役割]を担当する専門AIエージェントです。

## 使用可能なツール

[ツールの説明とパラメータ]

## 実行戦略

1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

## 重要なガイドライン

- [ガイドライン1]
- [ガイドライン2]

## エラーハンドリング

[エラー時の対応]
```

### 例1: シンプルな検索エージェント

```json
{
  "system_prompt": "あなたは、ServiceNowのナレッジベースを検索する専門エージェントです。\n\n## 検索手順\n\n1. まず`frontend_servicenow_search`で検索\n2. 結果が不十分なら、異なるキーワードで再検索\n3. 見つかった情報を簡潔にまとめる\n\n## 注意事項\n\n- 最大3回まで検索を試行\n- 見つからない場合は、その旨を明確に伝える"
}
```

### 例2: 複数ツールを使う高度なエージェント

```json
{
  "system_prompt": "あなたは、複数のツールを組み合わせて問題を解決する専門エージェントです。\n\n## 利用可能なツール\n\n1. `search_tool`: 初回検索用\n2. `detail_tool`: 詳細情報取得用\n3. `analysis_tool`: 分析用\n\n## 実行戦略\n\n### フェーズ1: 広範な検索\n- `search_tool`で概要を把握\n- 関連性の高い結果を特定\n\n### フェーズ2: 詳細調査\n- 上位3件について`detail_tool`で詳細取得\n- 情報の正確性を確認\n\n### フェーズ3: 分析\n- `analysis_tool`で結果を分析\n- ユーザーに最適な情報を提示\n\n## ツール使用の優先順位\n\n1. まず`search_tool`を必ず使用\n2. 結果が見つかったら`detail_tool`で詳細確認\n3. 必要に応じて`analysis_tool`で分析\n\n## エラー時の対応\n\n- ツール実行失敗時は代替ツールを使用\n- 3回失敗したら、ユーザーにエラーを報告"
}
```

### 例3: 条件分岐があるエージェント

```json
{
  "system_prompt": "あなたは、ユーザーの質問タイプに応じて異なる戦略を使う専門エージェントです。\n\n## 質問タイプの判定\n\n### タイプA: エラーコード検索\n**判定条件**: 質問に「エラー」「コード」「500」などが含まれる\n**戦略**:\n1. エラーコード単体で検索\n2. エラーメッセージで検索\n3. ナレッジ記事を優先\n\n### タイプB: 操作手順\n**判定条件**: 質問に「方法」「やり方」「手順」が含まれる\n**戦略**:\n1. 操作名で検索\n2. 詳細手順を含むナレッジを優先\n3. ステップバイステップで回答\n\n### タイプC: トラブルシューティング\n**判定条件**: 質問に「できない」「繋がらない」などが含まれる\n**戦略**:\n1. 症状で検索\n2. 過去の解決済みケースを参照\n3. 複数の解決策を提示\n\n## 実行フロー\n\n1. ユーザーの質問を分析し、タイプを判定\n2. タイプに応じた戦略で検索\n3. 結果を整理して提示"
}
```

## ベストプラクティス

### 1. 明確な役割定義

```json
{
  "system_prompt": "あなたは、[具体的な役割]です。\n\n[役割の詳細説明]"
}
```

### 2. ツールの使用順序を明記

```
## ツール使用の順序

1. まず[tool1]を使用
2. [条件]の場合は[tool2]を使用
3. 最後に[tool3]でまとめ
```

### 3. エラーハンドリングを含める

```
## エラー時の対応

- [tool1]が失敗した場合: [代替策]
- 検索結果が0件の場合: [再検索戦略]
- タイムアウトの場合: [対処法]
```

### 4. 出力フォーマットを指定

```
## 回答フォーマット

検索結果は以下の形式で提示してください:

## 結果サマリー
[概要]

## 推奨される解決策
1. [解決策1]
2. [解決策2]

## 詳細情報
[詳細]
```

### 5. 制約条件を明記

```
## 制約条件

- 検索は最大3回まで
- 各検索で異なるキーワードを使用
- レスポンスは2000文字以内
- 専門用語は説明を追加
```

## 高度なテクニック

### 動的な検索戦略

```json
{
  "system_prompt": "## 段階的検索戦略\n\n### レベル1: 完全一致検索\n- ユーザーのクエリをそのまま使用\n- 結果が10件以上: 成功\n- 結果が0-9件: レベル2へ\n\n### レベル2: 類義語検索\n- キーワードを類義語に置き換え\n- 例: エラー→問題、障害、失敗\n- 結果が5件以上: 成功\n- 結果が0-4件: レベル3へ\n\n### レベル3: 広範囲検索\n- より一般的な用語で検索\n- カテゴリ全体を対象\n- 結果を関連性でフィルタリング"
}
```

### コンテキスト活用

```json
{
  "system_prompt": "## ユーザーコンテキストの活用\n\nユーザー情報を考慮して回答をカスタマイズしてください:\n\n- テナント固有の用語を使用\n- 企業のビジョンに沿った説明\n- ユーザーの権限レベルに応じた情報提供\n\n会社のビジョンや用語は`request_context`から取得できます。"
}
```

### メトリクスの追跡

```json
{
  "system_prompt": "## 実行メトリクスの記録\n\n各検索の結果を記録してください:\n\n- 使用したキーワード\n- 検索結果数\n- 選択した記事/ケース\n- 実行時間\n\nこれにより、検索パターンを最適化できます。"
}
```

## トラブルシューティング

### system_promptが反映されない

- JSON形式が正しいか確認
- エスケープ文字（`\n`）が適切か確認
- 文字数制限（推奨: 4000文字以内）

### エージェントが指示に従わない

- より具体的な指示を追加
- 例を含める
- ステップを明確に番号付け

### ツールの使用順序が不適切

- `## ツール使用の順序`セクションを明記
- 条件分岐を明確に
- 各ステップの理由を説明

## 参考リンク

- [メインREADME](../../README.md)
- [動的ツール定義](../tool_definitions/README.md)
